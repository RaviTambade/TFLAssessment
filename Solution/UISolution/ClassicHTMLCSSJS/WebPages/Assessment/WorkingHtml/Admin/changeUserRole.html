<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - User Role Control</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: #f7f7f7;
      }
      .role-box {
        border: 1px solid #ddd;
        padding: 15px;
        background: #fff;
        border-radius: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h2 class="text-center mb-4">üîê Admin ‚Äì Manage User Roles</h2>

      <!-- Search Section -->
      <div class="card p-3 mb-4 shadow-sm">
        <h5>Search User</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <input
              type="text"
              id="mobileSearch"
              class="form-control"
              placeholder="Enter Mobile Number"
            />
          </div>
          <div class="col-md-3">
            <button class="btn btn-primary w-100" onclick="searchUser()">
              Search
            </button>
          </div>
        </div>
      </div>

      <!-- User Details -->
      <div id="userDetails" class="card p-3 shadow-sm" style="display: none">
        <h5>User Information</h5>
        <div class="row mt-2">
          <div class="col-md-6">
            <input type="hidden" id="userIdHidden">
            <p><strong>First Name:</strong> <span id="firstName"></span></p>
            <p><strong>Last Name:</strong> <span id="lastName"></span></p>
          </div>
          <div class="col-md-6">
            <p><strong>Mobile:</strong> <span id="mobile"></span></p>
            <p><strong>Email:</strong> <span id="email"></span></p>
          </div>
        </div>

        <hr />

        <!-- Role Selection -->
        <h5>Roles</h5>
        <div class="role-box" id="roleContainer"></div>

        <button class="btn btn-success mt-3" onclick="updateRole()">
          Update Role
        </button>
      </div>
    </div>

    <script>
      function loadRoles() {
        $.ajax({
          url: "http://localhost:5238/api/Role/roles",
          method: "GET",
          success: function (roles) {
            let container = document.getElementById("roleContainer");
            container.innerHTML = ""; // clear old roles

            roles.forEach((role) => {
              container.innerHTML += `
                    <div class="form-check">
                        <input class="form-check-input roleCheck" 
                               type="checkbox" 
                               value="${role.id}" 
                               id="role_${role.id}">
                        <label class="form-check-label" for="role_${role.id}">
                            ${role.name}
                        </label>
                    </div>
                `;
            });
          },
          error: function () {
            alert("Failed to load roles.");
          },
        });
      }

      // Load roles when page opens
      loadRoles();

      function searchUser() {
        const mobile = document.getElementById("mobileSearch").value.trim();

        if (mobile === "") {
          alert("Please enter mobile number");
          return;
        }

        $(document).ready(function () {
          $.ajax({
            url: `http://localhost:5238/api/UserProfile/contactno/${mobile}`,
            method: "GET",
            success: function (data) {
              // Fill user info
              document.getElementById("userIdHidden").value = data.id;
              document.getElementById("firstName").innerText = data.firstname;
              document.getElementById("lastName").innerText = data.lastname;
              document.getElementById("email").innerText = data.email;
              document.getElementById("mobile").innerText = data.contactNumber;

              // Step 1 ‚Üí uncheck all dynamic checkboxes
              document
                .querySelectorAll(".roleCheck")
                .forEach((chk) => (chk.checked = false));

              // Step 2 ‚Üí check roles based on role IDs
              data.roles.forEach((userRole) => {
                let checkbox = document.getElementById("role_" + userRole.id);
                if (checkbox) {
                  checkbox.checked = true;
                }
              });

              document.getElementById("userDetails").style.display = "block";
            },
            error: function (xhr, status, error) {
              console.error("Error fetching scores:", error);
              $("#studentLabel").text("Error loading scores.");
            },
          });
        });
      }
    
    
   function updateRole() {

    const userId = document.getElementById("userIdHidden").value;

    if (!userId) {
        alert("User not found. Search user first.");
        return;
    }

    let selectedRoles = [];
    document.querySelectorAll(".roleCheck:checked").forEach((chk) => {
        selectedRoles.push({
            id: parseInt(chk.value),
            name: chk.nextElementSibling.innerText,
            lob: ""  
        });
    });

    if (selectedRoles.length === 0) {
        alert("Please select at least one role.");
        return;
    }

    $.ajax({
        url: `http://localhost:5238/api/Membership/updaterole/${userId}`,
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(selectedRoles),

        success: function () {
            alert("Roles updated successfully!");
        },
        error: function (xhr) {
            console.error(xhr);
            alert("Failed to update roles.");
        }
    });
}

    </script>
  </body>
</html>
