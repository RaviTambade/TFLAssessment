<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Manage SME Subjects</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body {
            background: #f5f5f5;
        }
        .card {
            border-radius: 12px;
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <h2 class="text-center mb-4">üìò Admin ‚Äì Manage SME Subjects</h2>

    <div class="card p-3 shadow-sm">
        <h5>User SME Assignment</h5>

        <table class="table table-bordered mt-3">
            <thead class="table-light">
                <tr>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Email</th>
                    <th>Mobile</th>
                    <th>SME Subject</th>
                    <th>Action</th>
                </tr>
            </thead>

            <tbody id="userTableBody">
                <!-- Table rows will be loaded dynamically -->
            </tbody>
        </table>
    </div>
</div>

<script>

 allSubjects = [];   
 currentUserId = null;  // Track selected user

$(document).ready(function() {
    loadSubjects();
});

// Load all subjects
function loadSubjects() {
    $.ajax({
        url: "http://localhost:5238/api/subject/subjects", 
        method: "GET",
        success: function(subjects) {
            allSubjects = subjects;
            loadUsers();
        },
        error: function() {
            alert("Error loading subjects!");
        }
    });
}

// Load users & display comma-separated subjects
function loadUsers() {
    $.ajax({
        url: "http://localhost:5238/api/UserProfile/SmeUser",
        method: "GET",
        success: function(users) {

            let body = "";

            users.forEach(user => {

                let subjectText = "No Subject Assigned";

                if (user.subjects && user.subjects.length > 0) {
                    if (Array.isArray(user.subjects)) {
                       subjectText = user.subjects.map(s => s.title).join(", ");
                    } else {
                        subjectText = user.subjects;
                    }
                }

                body += `
                    <tr>
                        <td>${user.firstname}</td>
                        <td>${user.lastname}</td>
                        <td>${user.email}</td>
                        <td>${user.contactNumber}</td>
                        <td>${subjectText}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick='openSubjectSelector(${JSON.stringify(user)})'>
                                Update
                            </button>
                        </td>
                    </tr>
                `;
            });

            $("#userTableBody").html(body);
        },
        error: function() {
            alert("Error loading users!");
        }
    });
}

/* -----------------------------------------
      SHOW SUBJECT CHECKBOXES ABOVE TABLE
------------------------------------------ */
function openSubjectSelector(user) {

    currentUserId = user.userId;

     let assignedSubjects = Array.isArray(user.subjects)
        ? user.subjects.map(s => s.title)
        : [];

    let checkboxHTML = `
        <div id="subjectSelector" class="card p-3 mb-3 shadow-sm">
            <h5>Assign SME Subjects to: <b>${user.firstname} ${user.lastname}</b></h5>
            <div class="row">
    `;

    allSubjects.forEach(sub => {
        checkboxHTML += `
            <div class="col-md-3">
                <input type="checkbox" class="form-check-input subject-check"
                    value="${sub.title}"
                    ${assignedSubjects.includes(sub.title) ? "checked" : ""}>
                <label class="form-check-label">${sub.title}</label>
            </div>
        `;
    });

    // checkboxHTML += `
    //         </div>

    //         <button class="btn btn-success mt-3" onclick="saveSubjects()">Save</button>
    //         <button class="btn btn-secondary mt-3 ms-2" onclick="$('#subjectSelector').remove()">Cancel</button>
    //     </div>
    // `;

    $("#subjectSelector").remove();   // remove previous box
     $(".container").append(checkboxHTML); // ‚¨ÖÔ∏è Append at bottom
}


/* -----------------------------------------
          SAVE UPDATED SUBJECTS
------------------------------------------ */
function saveSubjects() {

    let selectedIds = [];

    $(".subject-check:checked").each(function() {
        selectedIds.push(parseInt($(this).val()));
    });

    let updateData = {
        userId: currentUserId,
        subjectIds: selectedIds
    };

    $.ajax({
        url: "http://localhost:5238/api/UserProfile/AssignSubjects",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(updateData),
        success: function() {
            alert("Subjects updated successfully!");
            $("#subjectSelector").remove();
            loadUsers();
        },
        error: function() {
            alert("Error updating subjects!");
        }
    });
}

</script>

</body>
</html>
