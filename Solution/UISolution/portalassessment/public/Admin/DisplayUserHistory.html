<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>User History Table</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>

<body class="font-sans p-5 bg-[#eef2f7]">

  <div id="historyContainer"></div>

  <script>

    function formatDate(datetime) {
      const date = new Date(datetime);
      return date.toLocaleDateString("en-GB", {
        day: "2-digit",
        month: "short",
        year: "numeric"
      });
    }

    function formatTime(datetime) {
      const date = new Date(datetime);
      return date.toLocaleTimeString("en-US", {
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function calculateDuration(start, end) {
      const startDate = new Date(start);
      const endDate = new Date(end);

      if (isNaN(startDate) || isNaN(endDate)) return "Invalid time";

      let diff = Math.abs(endDate - startDate);
      let hours = Math.floor(diff / (1000 * 60 * 60));
      let minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

      hours = hours > 0 ? `${hours}h` : "";
      minutes = minutes > 0 ? `${minutes}m` : "";

      return `${hours} ${minutes}`.trim() || "0m";
    }

    function userDetailHistory(userId) {

      $("#historyContainer").html("<p class='text-lg font-bold mt-2'>⏳ Loading...</p>");

      $.ajax({
        url: `http://localhost:5238/api/UserSession/history/${userId}`,
        method: "GET",
        success: function (data) {

          sessionData = data;

          if (!data || data.length === 0) {
            $("#historyContainer").html("<p class='text-lg font-bold mt-2 text-red-600'>⚠ No history found.</p>");
            return;
          }

          let html = `
          <table class="w-full border-collapse mt-5 bg-white rounded-lg shadow-md overflow-hidden">
            <thead>
              <tr>
                <th class="p-3 text-center bg-[#4a90e2] text-white font-bold uppercase">Date</th>
                <th class="p-3 text-center bg-[#4a90e2] text-white font-bold uppercase">Login Time</th>
                <th class="p-3 text-center bg-[#4a90e2] text-white font-bold uppercase">Logout Time</th>
                <th class="p-3 text-center bg-[#4a90e2] text-white font-bold uppercase">Duration</th>
              </tr>
            </thead>
            <tbody>
          `;

          data.forEach(item => {
            const isActive = item.sessionStatus === "ACTIVE";
            const logoutTime = isActive ? new Date() : item.logoutTime;

            html += `
              <tr class="hover:bg-[#f1f5ff]">
                <td class="p-3 text-center border-b border-gray-300">${formatDate(item.loginTime)}</td>
                <td class="p-3 text-center border-b border-gray-300">${formatTime(item.loginTime)}</td>
                <td class="p-3 text-center border-b border-gray-300">${isActive ? "Now" : formatTime(item.logoutTime)}</td>
                <td class="p-3 text-center border-b border-gray-300 duration-cell"><strong>${calculateDuration(item.loginTime, logoutTime)}</strong></td>
              </tr>`;
          });

          html += `</tbody></table>`;
          $("#historyContainer").html(html);
        },

        error: function () {
          $("#historyContainer").html("<p class='text-lg font-bold mt-2 text-red-600'>❌ Server error or no data found.</p>");
        }
      });
    }


    function updateDurationOnly() {
      $("#historyContainer table tbody tr").each(function (index) {
        let item = sessionData[index];
        if (!item) return;

        let isActive = item.sessionStatus === "ACTIVE";
        let newDuration = isActive
          ? calculateDuration(item.loginTime, new Date())
          : calculateDuration(item.loginTime, item.logoutTime);

        $(this).find("td.duration-cell").html(`<strong>${newDuration}</strong>`);
      });
    }


    function updateDurations() {
      $("#historyContainer").each(function () {
        const login = $(this).data("login");
        const isActive = $(this).data("active") === true || $(this).data("active") === "true";

        const logout = isActive ? new Date() : $(this).data("logout");

        $(this).text(calculateDuration(login, logout));
      });
    }

    $(document).ready(function () {
      userDetailHistory(userId);
    });

    setInterval(updateDurationOnly, 1000);

  </script>

</body>

</html>
