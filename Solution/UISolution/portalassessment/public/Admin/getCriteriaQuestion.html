<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subject Question Bank</title>

  <script src="../Script/Tailwind.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <div class="container mx-auto mt-8 px-4">
    <h2 class="text-2xl font-bold text-center mb-6">Subject Question Bank</h2>

    <!-- SUBJECT TABS -->
    <div id="subjectsTabs" class="flex gap-3 overflow-x-auto mb-4 py-2"></div>

    <!-- CRITERIA TABS -->
    <div id="criteriasTabs" class="flex gap-3 overflow-x-auto mb-3 py-2"></div>

    <!-- TITLE -->
    <h4 id="criteriaTitle" class="mb-3 text-blue-700 font-bold text-lg">
      Select a subject
    </h4>

    <!-- QUESTIONS -->
    <div id="questionList" class="space-y-3"></div>
  </div>

  <script>
    const SUBJECT_API = "http://localhost:5238/api/QuestionBank/questionCount";

    $(document).ready(function () {
      loadSubjects();
    });

    // --------------------------- LOAD SUBJECTS ---------------------------
    function loadSubjects() {
      $.ajax({
        url: SUBJECT_API,
        method: "GET",
        success: function (subjects) {
          $("#subjectsTabs").empty();

          subjects.forEach((sub) => {
            let tab = $(`
              <div class="subject-tab px-4 py-2 rounded-full bg-gray-200 cursor-pointer text-sm font-medium transition-colors">
                ${sub.subject.title} (${sub.questionCount})
              </div>
            `);

            tab.click(function () {
              $(".subject-tab").removeClass("bg-blue-600 text-white");
              $(this).addClass("bg-blue-600 text-white");

              loadCriteria(sub.subject.id, sub.subject.title);
              $("#criteriaTitle").text(`Select criteria for: ${sub.subject.title}`);
            });

            $("#subjectsTabs").append(tab);
          });
        },
        error: function () {
          alert("Failed to load subjects");
        },
      });
    }

    // --------------------------- LOAD CRITERIA ---------------------------
    function loadCriteria(subjectId, subjectName) {
      const CRITERIA_API = `http://localhost:5238/api/concepts/questioncount/${subjectId}`;

      $.ajax({
        url: CRITERIA_API,
        method: "GET",
        success: function (criteria) {
          $("#criteriasTabs").empty();
          $("#questionList").empty();
          $("#criteriaTitle").text(`Criteria for: ${subjectName}`);

          if (!criteria || criteria.length === 0) {
            $("#criteriasTabs").html(`
              <div class="text-red-600 font-bold">No criteria available for this subject.</div>
            `);
            return;
          }

          criteria.forEach((c) => {
            let tab = $(`
              <div class="criteria-tab px-4 py-2 rounded-full bg-gray-200 cursor-pointer text-sm font-medium transition-colors">
                ${c.concept.title} (${c.questionCount})
              </div>
            `);

            tab.click(function () {
              $(".criteria-tab").removeClass("bg-blue-600 text-white");
              $(this).addClass("bg-blue-600 text-white");

              loadQuestions(subjectId, c.concept.id, c.concept.title);
            });

            $("#criteriasTabs").append(tab);
          });
        },
        error: function () {
          alert("Failed to load criteria");
        },
      });
    }

    // --------------------------- LOAD QUESTIONS ---------------------------
    function loadQuestions(subjectId, criteriaId, criteriaTitle) {
      const QUESTION_API = `http://localhost:5238/api/questionbank/questions/subjects/${subjectId}/concepts/${criteriaId}`;

      $.ajax({
        url: QUESTION_API,
        method: "GET",
        success: function (questions) {
          $("#criteriaTitle").text(`${criteriaTitle} - Question Bank`);
          $("#questionList").empty();

          if (!questions || questions.length === 0) {
            $("#questionList").html(`<p>No questions available.</p>`);
            return;
          }

          questions.forEach((q, i) => {
            let card = $(`
              <div class="p-4 bg-white rounded-lg shadow cursor-pointer hover:shadow-md transition" onclick="QuestionDisplay(${q.questionId})">
                <strong>Q ${i+1}: ${q.question}</strong>
              </div>
            `);

            $("#questionList").append(card);
          });
        },
        error: function () {
          $("#questionList").html(`
            <div class="p-3 mt-2 text-center text-red-600 font-bold bg-red-100 rounded-lg">
              Error loading questions.
            </div>
          `);
        },
      });
    }

    // --------------------------- LOAD QUESTION DETAILS ---------------------------
    function QuestionDisplay(questionId) {
      $("#content").load("QuestionDetails.html", function () {
        QuestionDetails(questionId);
      });
    }
  </script>
</body>
</html>
