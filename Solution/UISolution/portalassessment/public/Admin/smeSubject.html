<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Manage SME Subjects</title>

    <script src="../Script/Tailwind.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>

  <body class="bg-[#f5f5f5]">

    <div class="max-w-6xl mx-auto mt-6 px-4">

      <h2 class="text-center mb-6 text-2xl font-bold">
        ðŸ“˜ Admin â€“ Manage SME Subjects
      </h2>

      <!-- Card -->
      <div class="bg-white p-6 rounded-xl shadow">

        <h5 class="text-lg font-semibold mb-4">User SME Assignment</h5>

        <!-- TABLE -->
        <div class="overflow-x-auto">
          <table class="w-full border border-gray-300 rounded-lg overflow-hidden">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-3 border">Name</th>
                <th class="p-3 border">SME Subject</th>
                <th class="p-3 border">Action</th>
              </tr>
            </thead>

            <tbody id="userTableBody" class="bg-white"></tbody>
          </table>
        </div>
      </div>

    </div>

    <script>

      allSubjects = [];
      currentUserId = null;

      $(document).ready(function () {
        loadSubjects();
      });

      // Load all subjects
      function loadSubjects() {
        $.ajax({
          url: "http://localhost:5238/api/subject/subjects",
          method: "GET",
          success: function (subjects) {
            allSubjects = subjects;
            loadUsers();
          },
          error: function () {
            alert("Error loading subjects!");
          },
        });
      }

      // Load all users
      function loadUsers() {
        $.ajax({
          url: "http://localhost:5238/api/UserProfile/SmeUser",
          method: "GET",
          success: function (users) {
            let body = "";

            users.forEach((user) => {
              let subjectText = "No Subject Assigned";

              if (user.subjects && user.subjects.length > 0) {
                if (Array.isArray(user.subjects)) {
                  subjectText = user.subjects.map((s) => s.title).join(", ");
                } else {
                  subjectText = user.subjects;
                }
              }

              body += `
                <tr class="border-b">
                  <td class="p-3">
                    <a href="#" class="text-blue-600 hover:underline" onclick="loadProfilePage(${user.userId})">
                      ${user.firstname} ${user.lastname}
                    </a>
                  </td>

                  <td class="p-3">${subjectText}</td>

                  <td class="p-3">
                    <button class="bg-blue-600 text-white py-1 px-3 rounded hover:bg-blue-700 text-sm"
                      onclick='openSubjectSelector(${JSON.stringify(user)})'>
                      Assign Subjects
                    </button>
                  </td>
                </tr>
              `;
            });

            $("#userTableBody").html(body);
          },
          error: function () {
            alert("Error loading users!");
          },
        });
      }


      // Open Subject Selector Component
      function openSubjectSelector(user) {
        currentUserId = user.id;

        let assignedSubjects = Array.isArray(user.subjects)
          ? user.subjects.map((s) => s.title)
          : [];

        let checkboxHTML = `
          <div id="subjectSelector" class="bg-white p-6 rounded-xl shadow max-w-6xl mx-auto mt-6 mb-8">

            <h5 class="text-lg font-semibold mb-4">
              Assign SME Subjects to: <b>${user.firstname} ${user.lastname}</b>
            </h5>

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        `;

        allSubjects.forEach((sub) => {
          checkboxHTML += `
            <div class="flex items-center gap-2">
              <input 
                type="checkbox" 
                class="subject-check h-4 w-4"
                data-id="${sub.id}"
                ${assignedSubjects.includes(sub.title) ? "checked" : ""}
              >
              <label class="text-gray-700">${sub.title}</label>
            </div>
          `;
        });

        checkboxHTML += `
            </div>
          </div>
        `;

        $("#subjectSelector").remove();
        $("body").append(checkboxHTML);

        $(".subject-check")
          .off("change")
          .on("change", function () {
            let subjectId = $(this).data("id");
            let isChecked = $(this).is(":checked");

            let url = isChecked
              ? `http://localhost:5238/api/Membership/assignsubject/${currentUserId}/addsubject/${subjectId}`
              : `http://localhost:5238/api/Membership/assignsubject/${currentUserId}/removesubject/${subjectId}`;

            $.ajax({
              url: url,
              method: "POST",
              success: function () {
                loadUsers();
              },
              error: function () {
                alert("Error updating subject!");
              },
            });
          });
      }


      function loadProfilePage(userId) {
        $("#content").load("../publicProfile.html", function () {
          loadUserProfile(userId);
        });
      }

    </script>
  </body>
</html>
